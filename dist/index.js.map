{"version":3,"sources":["../src/functions/bringIQData.ts","../src/types/iq.ts","../src/index.ts"],"sourcesContent":["import { elizaLogger } from \"@elizaos/core\";\nimport { Connection, PublicKey } from \"@solana/web3.js\";\n\n// Types\ninterface TransactionInfo {\n    argData?: {\n        type_field?: string;\n        offset?: string;\n        tail_tx?: string;\n    };\n}\n\ninterface TransactionData {\n    method: string;\n    code: string;\n    decode_break: number;\n    before_tx: string;\n}\n\ninterface TransactionDataResponse {\n    code: string;\n    method: string;\n    decode_break: number;\n}\n\ninterface CodeResult {\n    json_data: string;\n    commit_message: string;\n}\n\n// Constants\nconst NETWORK = process.env.IQSOlRPC || \"https://api.mainnet-beta.solana.com\";\nconst WALLET_ADDRESS = process.env.IQ_WALLET_ADDRESS;\nconst IQ_HOST = \"https://solanacontractapi.uc.r.appspot.com\";\nconst GENESIS_TX = \"Genesis\";\nconst ERROR_RESULT: CodeResult = {\n    json_data: \"false\",\n    commit_message: \"false\",\n};\n\n// Initialize connection\nconst connection = new Connection(NETWORK, \"confirmed\");\n\nasync function convertTextToEmoji(text: string): Promise<string> {\n    return text.replace(/\\/u([0-9A-Fa-f]{4,6})/g, (_, code) =>\n        String.fromCodePoint(Number.parseInt(code, 16))\n    );\n}\n\nasync function fetchTransactionInfo(\n    txId: string\n): Promise<TransactionInfo[\"argData\"] | null> {\n    try {\n        const response = await fetch(`${IQ_HOST}/get_transaction_info/${txId}`);\n        if (!response.ok) {\n            throw new Error(`HTTP error! status: ${response.status}`);\n        }\n\n        const data = await response.json();\n        return data.argData || null;\n    } catch (error) {\n        elizaLogger.error(\"Error fetching transaction info:\", error);\n        return null;\n    }\n}\n\nasync function fetchDBPDA(): Promise<string | null> {\n    if (!WALLET_ADDRESS) {\n        elizaLogger.error(\"Wallet address not provided\");\n        return null;\n    }\n\n    try {\n        elizaLogger.info(\"Connecting to Solana...(IQ6900)\");\n        elizaLogger.info(`Your Address: ${WALLET_ADDRESS}`);\n\n        const response = await fetch(`${IQ_HOST}/getDBPDA/${WALLET_ADDRESS}`);\n        if (!response.ok) {\n            throw new Error(`HTTP error! status: ${response.status}`);\n        }\n\n        const data = await response.json();\n        return data.DBPDA || null;\n    } catch (error) {\n        elizaLogger.error(\"Error fetching PDA:\", error);\n        return null;\n    }\n}\n\nasync function getTransactionData(transactionData: TransactionData): Promise<{\n    data: TransactionDataResponse | \"fail\";\n    before_tx: string;\n}> {\n    if (!transactionData || !(\"code\" in transactionData)) {\n        return {\n            data: \"fail\",\n            before_tx: \"fail\",\n        };\n    }\n\n    return {\n        data: {\n            code: transactionData.code,\n            method: transactionData.method,\n            decode_break: transactionData.decode_break,\n        },\n        before_tx: transactionData.before_tx,\n    };\n}\n\nasync function extractCommitMessage(dataTxid: string): Promise<string | null> {\n    const txInfo = await fetchTransactionInfo(dataTxid);\n    if (!txInfo) return null;\n\n    const type_field = txInfo.type_field || null;\n    if (type_field === \"json\" && txInfo.offset) {\n        const [, commitMessage] = txInfo.offset.split(\"commit: \");\n        return commitMessage || null;\n    }\n\n    return null;\n}\n\nfunction isTransactionDataResponse(data: TransactionDataResponse | \"fail\"): data is TransactionDataResponse {\n    return data !== \"fail\" && typeof data === \"object\" && \"code\" in data;\n}\n\nasync function bringCode(dataTxid: string): Promise<CodeResult> {\n    const txInfo = await fetchTransactionInfo(dataTxid);\n    if (!txInfo || !txInfo.tail_tx) return ERROR_RESULT;\n\n    const chunks: string[] = [];\n    let before_tx = txInfo.tail_tx;\n\n    if (before_tx === null) return ERROR_RESULT;\n\n    try {\n        while (before_tx !== GENESIS_TX) {\n            if (!before_tx) {\n                elizaLogger.error(\"Before transaction undefined\");\n                return ERROR_RESULT;\n            }\n\n            elizaLogger.info(`Chunks: ${before_tx}`);\n            const chunk = await fetchTransactionInfo(before_tx);\n\n            if (!chunk) {\n                elizaLogger.error(\"No chunk found\");\n                return ERROR_RESULT;\n            }\n\n            const chunkData = await getTransactionData(\n                chunk as TransactionData\n            );\n            if (!chunkData.data || !isTransactionDataResponse(chunkData.data)) {\n                elizaLogger.error(\"Chunk data undefined or invalid\");\n                return ERROR_RESULT;\n            }\n\n            chunks.push(chunkData.data.code);\n            before_tx = chunkData.before_tx;\n        }\n\n        const textData = chunks.reverse().join(\"\");\n        return {\n            json_data: await convertTextToEmoji(textData),\n            commit_message: txInfo.offset || \"false\",\n        };\n    } catch (error) {\n        elizaLogger.error(\"Error in bringCode:\", error);\n        return ERROR_RESULT;\n    }\n}\n\nasync function fetchSignaturesForAddress(\n    dbAddress: PublicKey\n): Promise<string[]> {\n    try {\n        elizaLogger.info(\"Find Your Signature...(IQ6900)\");\n        const signatures = await connection.getSignaturesForAddress(dbAddress, {\n            limit: 20,\n        });\n        return signatures.map((sig) => sig.signature);\n    } catch (error) {\n        elizaLogger.error(\"Error fetching signatures:\", error);\n        return [];\n    }\n}\n\nasync function findRecentJsonSignature(): Promise<string | null> {\n    const dbAddress = await fetchDBPDA();\n    if (!dbAddress) {\n        elizaLogger.error(\"Failed to fetch DBPDA\");\n        return null;\n    }\n\n    const signatures = await fetchSignaturesForAddress(\n        new PublicKey(dbAddress)\n    );\n    if (signatures.length === 0) {\n        elizaLogger.error(\"No signatures found\");\n        return null;\n    }\n\n    for (const signature of signatures) {\n        const commit = await extractCommitMessage(signature);\n        if (commit) return signature;\n    }\n\n    return null;\n}\n\nexport async function bringAgentWithWalletAddress(): Promise<string | null> {\n    const recent = await findRecentJsonSignature();\n    if (!recent) {\n        elizaLogger.error(\"Cannot found onchain data in this wallet.\");\n        return null;\n    }\n\n    const result = await bringCode(recent);\n    return result.json_data === \"false\" ? null : result.json_data;\n}\n","import { bringAgentWithWalletAddress } from \"../functions/bringIQData.ts\";\n\nconst onchainJson = await (async () => {\n    if (!process.env.IQ_WALLET_ADDRESS) {\n        return null;\n    }\n\n    return await bringAgentWithWalletAddress();\n})();\n\nexport { onchainJson };\n","import type { Plugin } from \"@elizaos/core\";\nexport { onchainJson } from \"./types/iq.ts\";\n\nexport const elizaCodeinPlugin: Plugin = {\n    name: \"eliza-codein\",\n    description: \"Plugin that interacts with the on-chain inscription method 'Code-In'\",\n    actions: [\n    ],\n    providers: [\n        /* custom providers */\n    ],\n    evaluators: [\n         /* custom evaluators */\n    ],\n    services: [],\n    clients: [],\n\n};\n"],"mappings":"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","names":[]}